#!/bin/bash

#SBATCH --partition=batch
#SBATCH --ntasks-per-node=1
#SBATCH --ntasks=2
#SBATCH --cpus-per-task=16
#SBATCH --mem-per-cpu=3072
#SBATCH --time=60:00
#SBATCH --output=outfile-%J
#SBATCH --gpus=8

#set -x

. setenv-spark-gpu.sh

$SPARK_HOME/sbin/start-all.sh

. wait-worker.sh

. setenv-bbsql-gpu.sh

echo $CMDPARAM

$SPARK_HOME/bin/spark-submit --verbose \
        $CMDPARAM \
	--conf spark.executor.extraJavaOptions="-Dai.rapids.cudf.nvtx.enabled=true -Dai.rapids.cudf.prefer-pinned=true -Dai.rapids.spark.semaphore.enabled=true" \
        --class ai.rapids.spark.examples.tpcxbb.Main \
        $BBSQL --xpu=GPU \
        --query="$QUERY" \
        --input="$INPUT_PATH" \
        --output="${OUTPUT_PATH}-gpu/$QUERY" 

#sleep infinity
$SPARK_HOME/sbin/stop-all.sh
